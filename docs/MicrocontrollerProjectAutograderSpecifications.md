# Microcontroller Project Autograder Specifications

**Author:** Tarang Janawalkar<br>
**Date:** July 17, 2024

## Contents

1. [Terminology](#terminology)  \
2. [Program Emulation](#program-emulation)  \
   2.1. [The Tests](#the-tests)  \
   2.2. [The Events](#the-events)  \
   2.3. [Dealing with Timing Errors](#dealing-with-timing-errors)  \
3. [Emulator Inputs](#emulator-inputs)  \
   3.1. [Potentiometer Updates](#potentiometer-updates)  \
   3.2. [Pushbutton Inputs](#pushbutton-inputs)  \
   3.3. [UART Inputs](#uart-inputs)  \
4. [Emulator Outputs](#emulator-outputs)  \
   4.1. [Buzzer Output](#buzzer-output)  \
   4.2. [Display Output](#display-output)  \
   4.3. [UART Output](#uart-output)

## Terminology

The following terms are used throughout this document to describe different aspects of the
autograding process.

- **Test**: A single execution of the emulator. (Note: a Gradescope test may contain multiple tests.)
- **Test output**: The text displayed under each test on Gradescope.
- **Input event**: Inputs provided to the emulator. These can alter the potentiometer position, the
  state of a pushbutton, or the UART RX net, causing a character to be transmitted to the
  ATtiny1626 via UART.
- **Gameplay input**: An input to the Simon game. These inputs can be correct (matching Simon) or
  incorrect (failing to match Simon).
- **Output event**: Outputs detected by the emulator. These include buzzer events, 7-segment
  display output, and characters transmitted from the ATtiny1626 via UART.
- **Event**: A group of buzzer and display output events generated by Simon or the user.

## Program Emulation

The autograder uses an emulator to simulate user input through various input events. The
emulator reads and parses all output events to evaluate a program.

### The Tests

Sixteen tests are executed, with some grouped under a single Gradescope test. Each test can differ
in emulator parameters such as timeout duration and input set. The tests and their corresponding
timeouts are listed below (actual times may vary by ±200 ns when using the default clock
prescalar):

1. Gameplay Test: 5505 ms
2. Pushbutton Hold Test: 7405 ms
3. Pushbutton Debouncing Test: 620 ms
4. Sequencing Test: 31 300 ms
5. Playback Delay Test:  
   A. 4737.5 ms  
   B. 8237.5 ms  
   C. 11 737.5 ms  
   D. 15 237.5 ms
6. Playback Frequency Test: 9550 ms
7. UART Gameplay Test: 5630 ms
8. UART Octave Test:  
   A. 2500 ms  
   B. 2500 ms
9. High Score Test: 30 700 ms
10. Reset Test: 2555 ms
11. Seed Test: 5500 ms
12. Mixed Input Test: 12 710 ms

Programs must respond to all inputs and produce the required outputs within the specified
timeouts.

### The Events

Each test simulates predetermined inputs that may expect specific outputs. The start time and
duration of these outputs are compared against an ideal program that receives identical inputs.
Tests produce a series of events that provide feedback on each output event. For example:

```
[EVENT 1 - Simon] [PLAYBACK DELAY: 250 ms]
PASS. Buzzer produced a 358.10 Hz tone at 0 ms for a duration of 125 ms.
PASS. Display produced "| " at 0 ms for a duration of 125 ms.

[EVENT 2 - User Input: (S1 (15 ms))]
PASS. Buzzer produced a 358.10 Hz tone at 350 ms for a duration of 125 ms.
PASS. Display produced "| " at 350 ms for a duration of 125 ms.

[INPUT SEQUENCE CORRECT]
PASS. Display produced "88" at 500 ms for a duration of 250 ms.
```

The amount of information logged varies between tests, depending on the evaluation criteria.

### Dealing with Timing Errors

The autograder allows for small tolerances in output events and inserts delays before all gameplay
inputs (pushbuttons or serial commands S1–S4). Output events are rejected if:

- A buzzer or display output event has a duration with a relative error greater than 15%.
- A buzzer or display output event occurs before the associated gameplay input is simulated.

Some outputs rely on future events to determine their duration. For instance, if a program omits
the score display on the 7-segment display after an incorrect gameplay input, the autograder may
be unable to determine how long the FAIL pattern should persist.

## Emulator Inputs

All valid inputs are logged in the test output alongside the relevant event.

### Potentiometer Updates

Adjusting the potentiometer modifies the playback delay, highlighted in the test output as:

```
[EVENT 1 - Simon] [PLAYBACK DELAY: 250 ms]
```

The new playback delay remains in effect until updated again.

### Pushbutton Inputs

Pressing a pushbutton generates buzzer and display outputs when the press duration is long enough
to account for mechanical switch bounce. Gameplay inputs appear in the test output, for example:

```
// S1 pressed for 15 ms
[EVENT 2 - User Input: (S1 (15 ms))]

// S1 pressed for 15 ms and S3 pressed for 15 ms
[EVENT 4 - User Input: (S1 (15 ms), S3 (15 ms))]
```

For events with multiple inputs, presses after the first occur after the playback delay plus a short
transition time between pushbuttons.

### UART Inputs

UART characters trigger different actions. UART-related tests display transmitted characters and,
when applicable, describe their effects. Example input log:

```
UART input:
 250 ms: 'k'
 350 ms: 'q'
1350 ms: ','
1450 ms: '1'
1700 ms: '3'
```

Example UART functions:

```
[EVENT 2 - User Input: ('q')]
[EVENT 4 - User Input: ('1', 'e')]
// S1
// S1 (alt) and S3

[EVENT 2 - User Input: ('q')] [OCTAVE: -1] // DEC FREQ
[EVENT 2 - User Input: ('q')] [OCTAVE: 1]  // INC FREQ
[EVENT 4 - Simon] [RESET]
[EVENT 3 - Simon] [SEED: 0x2DF599AC]
// RESET
// SEED
```

Non-gameplay inputs can be processed while the program waits for user input, before gameplay
inputs occur. Some UART inputs are randomized to account for alternative keys.

## Emulator Outputs

When enabled, the autograder logs buzzer and display output events at the start of a test’s output.
Example logs:

```
Detected buzzer events:
  0 ms: 358.10 Hz, 50.00 % duty cycle
125 ms: 0.00 Hz, 0.00 % duty cycle
300 ms: 358.10 Hz, 50.00 % duty cycle
425 ms: 0.00 Hz, 0.00 % duty cycle
...

Detected display events:
  0 ms: "| "
125 ms: "  "
300 ms: "| "
425 ms: "  "
...
```

UART output, when captured, is displayed at the end of a test after the emulator terminates, for
example:

```
UART output:
SUCCESS
1
GAME OVER
2
Enter name:
Patrick 2
SUCCESS
1
GAME OVER
2
Enter name:
Patrick 2
Jackson 2
```

### Buzzer Output

Evaluation of buzzer events verifies the tone’s start time, frequency, duty cycle, and duration. Tone
duration is computed as:

\[
\delta t = t_{\text{off}} - t_{\text{on}}
\]

where \(t_{\text{on}}\) is the first occurrence of the expected tone and \(t_{\text{off}}\) is the first
occurrence of a 0 Hz, 0% duty cycle tone after \(t_{\text{on}}\).

If a tone with an incorrect frequency is produced, the autograder skips ahead until it finds a tone
with the correct frequency, which can cause timing mismatches with the display. For example:

```
Detected buzzer events:
  0 ms: 358.10 Hz, 50.00 % duty cycle
125 ms: 0.00 Hz, 0.00 % duty cycle
350 ms: 478.00 Hz, 50.00 % duty cycle   // expected 358.10 Hz tone
475 ms: 0.00 Hz, 0.00 % duty cycle
725 ms: 358.10 Hz, 50.00 % duty cycle   // tone found at wrong time
850 ms: 0.00 Hz, 0.00 % duty cycle
...

Detected display events:
  0 ms: "| "
125 ms: "  "
350 ms: "| "
475 ms: "  "
475 ms: "88"
725 ms: "  "
725 ms: "| "
850 ms: "  "
...

[EVENT 1 - Simon] [PLAYBACK DELAY: 250 ms]
PASS. Buzzer produced a 358.10 Hz tone at 0 ms for a duration of 125 ms.
PASS. Display produced "| " at 0 ms for a duration of 125 ms.

[EVENT 2 - User Input: ('1')]
FAIL. Buzzer produced a 358.10 Hz tone at 725 ms for a duration of 125 ms.
PASS. Display produced "| " at 350 ms for a duration of 125 ms.

[INPUT SEQUENCE CORRECT]
PASS. Display produced "88" at 475 ms for a duration of 250 ms.
```

If no buzzer output is detected, or if a tone persists beyond 50% of the playback delay, testing
terminates after that event.

### Display Output

Display evaluation checks that pattern start times and durations fall within tolerance. The display is
multiplexed between two digits, so patterns requiring both digits produce transient outputs before
a steady state is detected. Example output:

```
Detected display events:
  0 ms: "| "
125 ms: "  "
350 ms: "| "
475 ms: "  "
475 ms: "8 "   // transience (LHS)
480 ms: " 8"   // transience (RHS)
485 ms: "88"   // steady state
725 ms: "  "
725 ms: "| "
...
```

Here, the 7-segment display refreshes every 5 ms, alternating between digits and reaching a steady
state after 10 ms. Improper multiplexing prevents detection of a steady state:

```
Detected display events:
  0 ms: "| "
125 ms: "  "
350 ms: "| "
475 ms: "  "
475 ms: "8 "
475 ms: " 8"
480 ms: "8 "
480 ms: " 8"
485 ms: "8 "
585 ms: " 8"
590 ms: "8 "
590 ms: " 8"
...
```

In this case, the left digit is illuminated for less than 1 ms while the right digit stays on for 5 ms,
preventing a steady-state reading.

### UART Output

UART output is captured when the emulator halts; the autograder verifies only that the correct text
is produced. Programs must match the specified formatting exactly. Debugging `printf` statements
should be removed before submission because they can degrade performance.
